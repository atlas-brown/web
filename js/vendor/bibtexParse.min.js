(function(e){function t(){this.months=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],this.notKey=[",","{","}"," ","="],this.pos=0,this.input="",this.entries=new Array,this.currentEntry="",this.setInput=function(e){this.input=e},this.getEntries=function(){return this.entries},this.isWhitespace=function(e){return e==" "||e=="\r"||e=="	"||e==`
`},this.match=function(e,t){if((t==null)&&(t=!0),this.skipWhitespace(t),this.input.substring(this.pos,this.pos+e.length)==e)this.pos+=e.length;else throw"Token mismatch, expected "+e+", found "+this.input.substring(this.pos);this.skipWhitespace(t)},this.tryMatch=function(e,t){return(t==null)&&(t=!0),this.skipWhitespace(t),this.input.substring(this.pos,this.pos+e.length)==e;this.skipWhitespace(t)},this.matchAt=function(){for(;this.input.length>this.pos&&this.input[this.pos]!="@";)this.pos++;return this.input[this.pos]=="@"},this.skipWhitespace=function(e){for(;this.isWhitespace(this.input[this.pos]);)this.pos++;if(this.input[this.pos]=="%"&&e==!0){for(;this.input[this.pos]!=`
`;)this.pos++;this.skipWhitespace(e)}},this.value_braces=function(){var e,n,s,t=0;for(this.match("{",!1),n=this.pos,e=!1;!0;){if(!e)if(this.input[this.pos]=="}")if(t>0)t--;else return s=this.pos,this.match("}",!1),this.input.substring(n,s);else if(this.input[this.pos]=="{")t++;else if(this.pos>=this.input.length-1)throw"Unterminated value";this.input[this.pos]=="\\"&&e==!1?e=!0:e=!1,this.pos++}},this.value_comment=function(){for(var e="",t=0;!this.tryMatch("}",!1)||t!=0;){if(e=e+this.input[this.pos],this.input[this.pos]=="{"&&t++,this.input[this.pos]=="}"&&t--,this.pos>=this.input.length-1)throw"Unterminated value:"+this.input.substring(start);this.pos++}return e},this.value_quotes=function(){this.match('"',!1);for(var n,t=this.pos,e=!1;!0;){if(!e){if(this.input[this.pos]=='"')return n=this.pos,this.match('"',!1),this.input.substring(t,n);if(this.pos>=this.input.length-1)throw"Unterminated value:"+this.input.substring(t)}this.input[this.pos]=="\\"&&e==!1?e=!0:e=!1,this.pos++}},this.single_value=function(){var e,t=this.pos;if(this.tryMatch("{"))return this.value_braces();if(this.tryMatch('"'))return this.value_quotes();if(e=this.key(),e.match("^[0-9]+$"))return e;if(this.months.indexOf(e.toLowerCase())>=0)return e.toLowerCase();throw"Value expected:"+this.input.substring(t)+" for key: "+e},this.value=function(){var e=[];for(e.push(this.single_value());this.tryMatch("#");)this.match("#"),e.push(this.single_value());return e.join("")},this.key=function(e){for(var t=this.pos;!0;){if(this.pos>=this.input.length)throw"Runaway key";if(this.notKey.indexOf(this.input[this.pos])>=0)return e&&this.input[this.pos]!=","?(this.pos=t,null):this.input.substring(t,this.pos);this.pos++}},this.key_equals_value=function(){var t,e=this.key();if(this.tryMatch("="))return this.match("="),t=this.value(),e=e.trim(),[e,t];throw"... = value expected, equals sign missing:"+this.input.substring(this.pos)},this.key_value_list=function(){var e=this.key_equals_value();for(this.currentEntry.entryTags={},this.currentEntry.entryTags[e[0]]=e[1];this.tryMatch(",");){if(this.match(","),this.tryMatch("}"))break;e=this.key_equals_value(),this.currentEntry.entryTags[e[0]]=e[1]}},this.entry_body=function(e){this.currentEntry={},this.currentEntry.citationKey=this.key(!0),this.currentEntry.entryType=e.substring(1),this.currentEntry.citationKey!=null&&this.match(","),this.key_value_list(),this.entries.push(this.currentEntry)},this.directive=function(){return this.match("@"),"@"+this.key()},this.preamble=function(){this.currentEntry={},this.currentEntry.entryType="PREAMBLE",this.currentEntry.entry=this.value_comment(),this.entries.push(this.currentEntry)},this.comment=function(){this.currentEntry={},this.currentEntry.entryType="COMMENT",this.currentEntry.entry=this.value_comment(),this.entries.push(this.currentEntry)},this.entry=function(e){this.entry_body(e)},this.alernativeCitationKey=function(){this.entries.forEach(function(e){!e.citationKey&&e.entryTags&&(e.citationKey="",e.entryTags.author&&(e.citationKey+=e.entryTags.author.split(",")[0]+=", "),e.citationKey+=e.entryTags.year)})},this.bibtex=function(){for(;this.matchAt();){var e=this.directive();this.match("{"),e.toUpperCase()=="@STRING"?this.string():e.toUpperCase()=="@PREAMBLE"?this.preamble():e.toUpperCase()=="@COMMENT"?this.comment():this.entry(e),this.match("}")}this.alernativeCitationKey()}}e.toJSON=function(e){var n=new t;return n.setInput(e),n.bibtex(),n.entries},e.toBibtex=function(e){var t,s,o,n="";for(t in e){if(n+="@"+e[t].entryType,n+="{",e[t].citationKey&&(n+=e[t].citationKey+", "),e[t].entry&&(n+=e[t].entry),e[t].entryTags){s="";for(o in e[t].entryTags)s.length!=0&&(s+=", "),s+=o+"= {"+e[t].entryTags[o]+"}";n+=s}n+=`}

`}return n}})(typeof exports=="undefined"?this.bibtexParse={}:exports)