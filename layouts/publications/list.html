{{ define "main" }}
{{ $entries := site.Data.publications_generated.entries | default (slice) }}
{{ $atlasNames := dict }}
{{ range site.Data.team.people }}
  {{ $nameKey := replace (urlize .name) "-" "" }}
  {{ if $nameKey }}
    {{ $atlasNames = merge $atlasNames (dict $nameKey true) }}
  {{ end }}
{{ end }}
{{ range site.Data.team.alumni }}
  {{ $alumniName := "" }}
  {{ if reflect.IsMap . }}
    {{ $alumniName = printf "%v" (index . "name") }}
  {{ else }}
    {{ $alumniName = printf "%v" . }}
  {{ end }}
  {{ $alumniKey := replace (urlize $alumniName) "-" "" }}
  {{ if $alumniKey }}
    {{ $atlasNames = merge $atlasNames (dict $alumniKey true) }}
  {{ end }}
{{ end }}
{{ $yearsDict := dict }}
{{ range $entries }}
  {{ $y := printf "%v" .year }}
  {{ if not (isset $yearsDict $y) }}
    {{ $yearsDict = merge $yearsDict (dict $y true) }}
  {{ end }}
{{ end }}
{{ $years := slice }}
{{ range $k, $_ := $yearsDict }}
  {{ $years = $years | append (int $k) }}
{{ end }}
{{ $years = sort $years "value" "desc" }}
<section class="mt-0 prose max-w-full flex flex-col dark:prose-invert">
  <div class="min-w-0 min-h-0 max-w-prose">
    <h2>Publications</h2>

    <div
      id="publicationsApp"
      class="publications-container"
    >
      <div class="flex flex-col gap-16 mb-16 not-prose">
        <div>
          <input
            type="text"
            id="pubSearch"
            placeholder="Search keywords..."
            class="publication-search"
          >
        </div>

        <div>
          <h3 class="filter-title">Types</h3>
          <div id="typeFilters" class="filter-row"></div>
        </div>

        <div>
          <h3 class="filter-title">Years</h3>
          <div id="yearFilters" class="filter-row"></div>
        </div>
      </div>

      <p id="pubNoResults" class="pub-status hidden">No publications match the current filters.</p>

      <div id="publicationYears">
        {{ range $year := $years }}
        <div class="year-block mt-12 mb-6" data-year="{{ $year }}">
          <h2 class="text-2xl font-bold text-gray-400 dark:text-gray-500 mb-2">{{ $year }}</h2>
          <hr class="border-t border-gray-300 dark:border-gray-600 mb-4">
          <ul class="space-y-4">
            {{ range $i, $entry := where $entries "year" $year }}
              {{ $absID := printf "abs-%s-%d" (replaceRE "[^A-Za-z0-9_-]" "-" $entry.id) $i }}
              {{ $bibID := printf "bib-%s-%d" (replaceRE "[^A-Za-z0-9_-]" "-" $entry.id) $i }}
              {{ $pdfPath := printf "pdf/%s.pdf" $entry.id }}
              {{ $pdfStaticPath := printf "static/%s" $pdfPath }}
              {{ $pdfURL := relURL $pdfPath }}
              {{ $search := printf "%s %s %s %s %v" $entry.title $entry.authors $entry.venue $entry.type $entry.year }}
              <li class="pub" data-type="{{ $entry.type }}" data-year="{{ $entry.year }}" data-search="{{ lower $search }}">
                {{ if $entry.url }}
                  <strong><a href="{{ $entry.url }}" target="_blank" rel="noopener noreferrer">{{ $entry.title }}</a></strong><br>
                {{ else }}
                  <strong>{{ $entry.title }}</strong><br>
                {{ end }}

                {{ if $entry.authors }}
                  {{ $authorParts := slice }}
                  {{ range split $entry.authors ", " }}
                    {{ $author := trim . " " }}
                    {{ $authorKey := replace (urlize $author) "-" "" }}
                    {{ if isset $atlasNames $authorKey }}
                      {{ $authorParts = $authorParts | append (printf `<span class="pub-author-atlas">%s</span>` ($author | htmlEscape)) }}
                    {{ else }}
                      {{ $authorParts = $authorParts | append ($author | htmlEscape) }}
                    {{ end }}
                  {{ end }}
                  {{ delimit $authorParts ", " | safeHTML }}.
                {{ end }}
                {{ if $entry.venue }}<em>{{ $entry.venue }}</em>{{ end }}<br>

                {{ $links := slice }}
                {{ if fileExists $pdfStaticPath }}
                  {{ $links = $links | append (printf `<a href="%s" target="_blank" rel="noopener noreferrer">PDF</a>` $pdfURL) }}
                {{ else if $entry.pdf }}
                  {{ $links = $links | append (printf `<a href="%s" target="_blank" rel="noopener noreferrer">PDF</a>` $entry.pdf) }}
                {{ end }}
                {{ if $entry.doi }}{{ $links = $links | append (printf `<a href="https://doi.org/%s" target="_blank" rel="noopener noreferrer">DOI</a>` $entry.doi) }}{{ else if $entry.url }}{{ $links = $links | append (printf `<a href="%s" target="_blank" rel="noopener noreferrer">URL</a>` $entry.url) }}{{ end }}
                {{ if $entry.code }}{{ $links = $links | append (printf `<a href="%s" target="_blank" rel="noopener noreferrer">Code</a>` $entry.code) }}{{ end }}
                {{ if $entry.abstract }}{{ $links = $links | append (printf `<button type="button" class="pub-action-link" data-abs-id="%s">Abstract</button>` $absID) }}{{ end }}
                {{ if $entry.bibtex }}{{ $links = $links | append (printf `<a href="#" class="pub-action-link" data-bib-id="%s">Cite</a>` $bibID) }}{{ end }}

                {{ if gt (len $links) 0 }}
                <span class="links text-sm">[ {{ delimit $links " | " | safeHTML }} ]</span>
                {{ end }}

                {{ if $entry.abstract }}
                <div id="{{ $absID }}" class="hidden abstract-block mt-2 text-sm italic">{{ $entry.abstract }}</div>
                {{ end }}
                {{ if $entry.bibtex }}
                <div id="{{ $bibID }}" class="hidden bibtex-block">
                  {{ highlight $entry.bibtex "bibtex" "linenos=false" }}
                </div>
                {{ end }}
              </li>
            {{ end }}
          </ul>
        </div>
        {{ end }}
      </div>
    </div>
  </div>
</section>


<!-- External JS + CSS -->
{{ $js := resources.Get "js/publications.js" | minify }}
<script src="{{ $js.RelPermalink }}"></script>

{{ $css := resources.Get "css/publications.css" | minify }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}">

{{ end }}
