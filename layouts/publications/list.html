{{ define "main" }}

{{/* -------------------------------  PRE-COLLECT TYPES  ------------------------------- */}}
{{ $types := slice }}
{{ $categories := slice }}

{{ range $pubs := $.Site.Data.publications }}
  {{ range $entry := $pubs.entries }}

    {{/* Collect types */}}
    {{ if not (in $types $entry.ENTRYTYPE) }}
      {{ $types = $types | append $entry.ENTRYTYPE }}
    {{ end }}

    {{/* Collect categories */}}
    {{ with $entry.category }}
      {{ if not (in $categories .) }}
        {{ $categories = $categories | append . }}
      {{ end }}
    {{ end }}

  {{ end }}
{{ end }}


<section class="mt-0 prose max-w-full flex flex-col dark:prose-invert">
  <div class="min-w-0 min-h-0 max-w-prose">
    <h2>Publications</h2>

    <div class="publications-container">
      <!-- FILTER BLOCK -->
      <div class="flex flex-col gap-16 mb-16 not-prose">

          <!-- SEARCH BAR -->
          <div>
            <input type="text" id="pubSearch"
                   placeholder="Search keywords..."
                   class="publication-search">
          </div>
    
        <!-- TYPES ROW -->
        <div>
          <h3 class="filter-title">Types</h3>
          <div class="filter-row">
            {{ range $types }}
            <label class="pill cursor-pointer filter-type" data-value="{{ lower . }}">
              <span>{{ . }}</span>
              <span class="pill-x hidden">X</span>
            </label>            
            {{ end }}
          </div>
        </div>
    
        <!-- CATEGORIES ROW -->
        <div>
          <h3 class="filter-title">Categories</h3>
          <div class="filter-row">
            {{ range $categories }}
            <label class="pill cursor-pointer filter-type" data-value="{{ lower . }}">
              <span>{{ . }}</span>
              <span class="pill-x hidden">X</span>
            </label>            
            {{ end }}
          </div>
        </div>
    
      </div> <!-- END FILTER BLOCK -->


    <!-- PUBLICATIONS LIST -->
    {{ $pubs := $.Site.Data.publications }}
    {{ range $pubs }}
    <div class="year-block mt-12 mb-6">
      <h2 class="text-2xl font-bold text-gray-400 dark:text-gray-500 mb-2">{{ .year }}</h2>
      <hr class="border-t border-gray-300 dark:border-gray-600 mb-4">

      <ul class="space-y-4">
        {{ range .entries }}
        <li class="pub" data-type="{{ lower .ENTRYTYPE }}" data-category="{{ lower .category }}">

          {{ if .url }}
            <strong><a href="{{ .url }}" target="_blank">{{ .title }}</a></strong><br>
          {{ else }}
            <strong>{{ .title }}</strong><br>
          {{ end }}

          {{ .author }}.
          <em>{{ .booktitle }}</em><br>

          {{/* LINKS */}}
          {{ $links := slice }}
          {{ if .pdf }}{{ $links = $links | append (printf `<a href="%s" target="_blank">PDF</a>` .pdf) }}{{ end }}
          {{ if .url }}{{ $links = $links | append (printf `<a href="%s" target="_blank">DOI</a>` .url) }}{{ end }}
          {{ if .code }}{{ $links = $links | append (printf `<a href="%s" target="_blank">Code</a>` .code) }}{{ end }}
          {{ if .abstract }}{{ $links = $links | append (printf `<a href="javascript:void(0);" onclick="toggleBlock('abs-%s')">Abstract</a>` .ID) }}{{ end }}
          {{ if .raw_bib_html }}{{ $links = $links | append (printf `<a href="javascript:void(0);" onclick="toggleBlock('bib-%s')">BibTeX</a>` .ID) }}{{ end }}

          <span class="links text-sm">[ {{ delimit $links " | " }} ]</span>

          {{ if .abstract }}
          <div id="abs-{{ .ID }}" class="hidden abstract-block mt-2 text-sm italic">{{ .abstract }}</div>
          {{ end }}

          {{ if .raw_bib_html }}
          <div id="bib-{{ .ID }}" class="hidden mt-2 text-sm">{{ .raw_bib_html | safeHTML }}</div>
          {{ end }}

        </li>
        {{ end }}
      </ul>
    </div>
    {{ end }}

  </div>
</section>


<!-- External JS + CSS -->
{{ $js := resources.Get "js/publications.js" | minify }}
<script src="{{ $js.RelPermalink }}"></script>

{{ $css := resources.Get "css/publications.css" | minify }}
<link rel="stylesheet" href="{{ $css.RelPermalink }}">

{{ end }}
