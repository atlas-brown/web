name: Build Site Artifact

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.120.3"
          extended: true

      - name: Build publications data
        run: npm run build:publications

      - name: Build site
        run: hugo --cleanDestinationDir --minify

      - name: Pack site artifact
        run: tar -C public -czf atlas-web.tar.gz .

      - name: Publish stable release artifact
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="site-latest"
          TITLE="Site Build (latest)"
          NOTES="Automated site build from ${GITHUB_SHA}"
          REPO_API="repos/${GITHUB_REPOSITORY}"

          # Force-move the stable tag to this workflow's commit.
          if gh api "${REPO_API}/git/ref/tags/${TAG}" >/dev/null 2>&1; then
            gh api \
              --method PATCH \
              "${REPO_API}/git/refs/tags/${TAG}" \
              -f sha="${GITHUB_SHA}" \
              -F force=true >/dev/null
          else
            gh api \
              --method POST \
              "${REPO_API}/git/refs" \
              -f ref="refs/tags/${TAG}" \
              -f sha="${GITHUB_SHA}" >/dev/null
          fi

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" atlas-web.tar.gz --clobber
            gh release edit "$TAG" --target "${GITHUB_SHA}" --title "$TITLE" --notes "$NOTES"
          else
            gh release create "$TAG" atlas-web.tar.gz --target "${GITHUB_SHA}" --title "$TITLE" --notes "$NOTES"
          fi
